-- Female Outfits List
local femaleOutfits = {
	["Citizen"] = {136},
	["Hunter"] = {137},
	["Mage"] = {138},
	["Knight"] = {139},
	["Noblewoman"] = {140},
	["Summoner"] = {141},
	["Warrior"] = {142},
	["Barbarian"] = {147},
	["Druid"] = {148},
	["Wizard"] = {149},
	["Oriental"] = {150},
	["Pirate"] = {155},
	["Assassin"] = {156},
	["Beggar"] = {157},
	["Shaman"] = {158},
	["Norsewoman"] = {252},
	["Nightmare"] = {269},
	["Jester"] = {270},
	["Brotherhood"] = {279},
	["Demon Hunter"] = {288},
	["Yalaharian"] = {324},
	["Newly Wed"] = {329},
	["Warmaster"] = {336},
	["Wayfarer"] = {366},
	["Afflicted"] = {431},
	["Elementalist"] = {433},
	["Deepling"] = {464},
	["Insectoid"] = {466},
	["Entrepreneur"] = {471},
	["Crystal Warlord"] = {513},
	["Soil Guardian"] = {514},
	["Demon"] = {542},
	["Cave Explorer"] = {575},
	["Dream Warden"] = {578},
	["Glooth Engineer"] = {618},
	["Jersey"] = {620},
	["Champion"] = {632},
	["Conjurer"] = {635},
	["Beastmaster"] = {636},
	["Chaos Acolyte"] = {664},
	["Death Herald"] = {666},
	["Ranger"] = {683},
	["Ceremonial Garb"] = {694},
	["Puppeteer"] = {696},
	["Spirit Caller"] = {698},
	["Evoker"] = {724},
	["Seaweaver"] = {732},
	["Recruiter"] = {745},
	["Sea Dog"] = {749},
	["Royal Pumpkin"] = {759},
	["Rift Warrior"] = {845},
	["Winter Warden"] = {852},
	["Philosopher"] = {874},
	["Arena Champion"] = {885},
	["Lupine Warden"] = {900},
	["Grove Keeper"] = {909},
	["Festive"] = {929},
	["Pharaoh"] = {956},
	["Trophy Hunter"] = {958},
	["Retro Warrior"] = {963},
	["Retro Summoner"] = {965},
	["Retro Noblewoman"] = {967},
	["Retro Mage"] = {969},
	["Retro Knight"] = {971},
	["Retro Hunter"] = {973},
	["Retro Citizen"] = {975},
	["Herbalist"] = {1020},
	["Sun Priest"] = {1024},
	["Makeshift Warrior"] = {1043},
	["Siege Master"] = {1050},
	["Mercenary"] = {1057},
	["Battle Mage"] = {1070},
	["Discoverer"] = {1095},
	["Sinister Archer"] = {1103},
	["Pumpkin Mummy"] = {1128},
	["Dream Warrior"] = {1147},
	["Percht Raider"] = {1162},
	["Owl Keeper"] = {1174},
	["Guidon Bearer"] = {1187},
	["Void Master"] = {1203},
	["Veteran Paladin"] = {1205},
	["Lion of War"] = {1207},
	["Golden"] = {1211},
	["Hand of the Inquisition"] = {1244},
	["Breezy Garb"] = {1246},
	["Orcsoberfest Garb"] = {1252},
	["Poltergeist"] = {1271},
	["Herder"] = {1280},
	["Falconer"] = {1283},
	["Dragon Slayer"] = {1289},
	["Trailblazer"] = {1293},
	["Revenant"] = {1323},
	["Jouster"] = {1332},
	["Moth Cape"] = {1339},
	["Rascoohan"] = {1372},
	["Merry Garb"] = {1383},
	["Rune Master"] = {1385},
	["Citizen of Issavi"] = {1387},
	["Forest Warden"] = {1416},
	["Royal Bounacean Advisor"] = {1437},
	["Dragon Knight"] = {1445},
	["Arbalester"] = {1450}
}

-- Male Outfits List
local maleOutfits = {
	["Citizen"] = {128},
	["Hunter"] = {129},
	["Mage"] = {130},
	["Knight"] = {131},
	["Nobleman"] = {132},
	["Summoner"] = {133},
	["Warrior"] = {134},
	["Barbarian"] = {143},
	["Druid"] = {144},
	["Wizard"] = {145},
	["Oriental"] = {146},
	["Pirate"] = {151},
	["Assassin"] = {152},
	["Beggar"] = {153},
	["Shaman"] = {154},
	["Norseman"] = {251},
	["Nightmare"] = {268},
	["Jester"] = {273},
	["Brotherhood"] = {278},
	["Demon Hunter"] = {289},
	["Yalaharian"] = {325},
	["Newly Wed"] = {328},
	["Warmaster"] = {335},
	["Wayfarer"] = {367},
	["Afflicted"] = {430},
	["Elementalist"] = {432},
	["Deepling"] = {463},
	["Insectoid"] = {465},
	["Entrepreneur"] = {472},
	["Crystal Warlord"] = {512},
	["Soil Guardian"] = {516},
	["Demon"] = {541},
	["Cave Explorer"] = {574},
	["Dream Warden"] = {577},
	["Glooth Engineer"] = {610},
	["Jersey"] = {619},
	["Champion"] = {633},
	["Conjurer"] = {634},
	["Beastmaster"] = {637},
	["Chaos Acolyte"] = {665},
	["Death Herald"] = {667},
	["Ranger"] = {684},
	["Ceremonial Garb"] = {695},
	["Puppeteer"] = {697},
	["Spirit Caller"] = {699},
	["Evoker"] = {725},
	["Seaweaver"] = {733},
	["Recruiter"] = {746},
	["Sea Dog"] = {750},
	["Royal Pumpkin"] = {760},
	["Rift Warrior"] = {846},
	["Winter Warden"] = {853},
	["Philosopher"] = {873},
	["Arena Champion"] = {884},
	["Lupine Warden"] = {899},
	["Grove Keeper"] = {908},
	["Festive"] = {931},
	["Pharaoh"] = {955},
	["Trophy Hunter"] = {957},
	["Retro Warrior"] = {962},
	["Retro Summoner"] = {964},
	["Retro Nobleman"] = {966},
	["Retro Mage"] = {968},
	["Retro Knight"] = {970},
	["Retro Hunter"] = {972},
	["Retro Citizen"] = {974},
	["Herbalist"] = {1021},
	["Sun Priest"] = {1023},
	["Makeshift Warrior"] = {1042},
	["Siege Master"] = {1051},
	["Mercenary"] = {1056},
	["Battle Mage"] = {1069},
	["Discoverer"] = {1094},
	["Sinister Archer"] = {1102},
	["Pumpkin Mummy"] = {1127},
	["Dream Warrior"] = {1146},
	["Percht Raider"] = {1161},
	["Owl Keeper"] = {1173},
	["Guidon Bearer"] = {1186},
	["Void Master"] = {1202},
	["Veteran Paladin"] = {1204},
	["Lion of War"] = {1206},
	["Golden"] = {1210},
	["Hand of the Inquisition"] = {1243},
	["Breezy Garb"] = {1245},
	["Orcsoberfest Garb"] = {1251},
	["Poltergeist"] = {1270},
	["Herder"] = {1279},
	["Falconer"] = {1282},
	["Dragon Slayer"] = {1288},
	["Trailblazer"] = {1292},
	["Revenant"] = {1322},
	["Jouster"] = {1331},
	["Moth Cape"] = {1338},
	["Rascoohan"] = {1371},
	["Merry Garb"] = {1382},
	["Rune Master"] = {1384},
	["Citizen of Issavi"] = {1386},
	["Forest Warden"] = {1415},
	["Royal Bounacean Advisor"] = {1436},
	["Dragon Knight"] = {1444},
	["Arbalester"] = {1449}
}

local gesiorShopSystem = GlobalEvent("GesiorShopSystem")

function gesiorShopSystem.onThink(interval)
	local resultId = db.storeQuery("SELECT * FROM z_ots_comunication")
	if resultId ~= false then
		repeat
			local transactionId = tonumber(result.getDataInt(resultId, "id"))
			local player = Player(result.getDataString(resultId, "name"))

		if player then
			local itemId = result.getDataInt(resultId, "param1")
			local itemCount = result.getDataInt(resultId, "param2")
			local shopOfferType = result.getDataString(resultId, "param5")
			local shopOfferName = result.getDataString(resultId, "param6")
			local coins = result.getDataInt(resultId, "param8")

			local receivedItemStatus
			-- Get player store inbox as container, so we can add item to it
			local playerStoreInbox = player:getSlotItem(CONST_SLOT_STORE_INBOX)

			-- Deliver item
			if shopOfferType == 'item' then
				local newItemUID = doCreateItemEx(itemId, itemCount)
				-- Item does not exist, wrong id or count
				if not newItemUID then
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'Website Shop bugged. Contact with administrator! Error is visible in server console.')
					Spdlog.error('ERROR! Website Shop (' .. player:getName() .. ') - cannot create item - invalid item ID OR count - ITEM ID: ' .. itemId .. ', ITEM COUNT: ' .. itemCount)
					return false
				end
				-- Cannot open Store Inbox, report problem
				if not playerStoreInbox then
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'Website Shop bugged. Contact with administrator! Error is visible in server console.')
					Spdlog.error('ERROR! Website Shop (' .. player:getName() .. ') - cannot open player "Store Inbox" - it is not supported in your server OR variable "CONST_SLOT_STORE_INBOX" is not defined in LUA')
					return false
				end

				-- Add container with items to Store Inbox
				local newItem = Item(newItemUID)
				receivedItemStatus = playerStoreInbox:addItemEx(newItem)

				if type(receivedItemStatus) == "number" and receivedItemStatus == RETURNVALUE_NOERROR then
					player:getPosition():sendMagicEffect(CONST_ME_GIFT_WRAPS)
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'You received ' .. shopOfferName .. ' from Website Shop. You can find your item in Store Inbox.')
					db.asyncQuery("DELETE FROM `z_ots_comunication` WHERE `id` = " .. transactionId)
					db.asyncQuery("UPDATE `z_shop_history_item` SET `trans_state`= 'realized', `trans_real`=" .. os.time() .. " WHERE `id` = " .. transactionId)
					return true
				else
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'Website Shop bugged. Contact with administrator! Error is visible in server console.')
					Spdlog.error('ERROR! Website Shop (' .. player:getName() .. ') - cannot add item to Store Inbox - unknown reason, is it\'s size limited and it is full? - ITEM ID: ' .. itemId .. ', ITEM COUNT: ' .. itemCount)
					return false
				end
			end

			--Deliver Container
			local containerId = result.getDataInt(resultId, "param3")
			local containerItemsInsideCount = result.getDataInt(resultId, "param4")
			if shopOfferType == 'container' then
				-- Create empty container
				local newContainerUID = doCreateItemEx(containerId, 1)
				-- Container item does not exist OR item is not Container
				if not newContainerUID or not Container(newContainerUID) then
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'Website Shop bugged. Contact with administrator! Error is visible in server console.')
					Spdlog.error('ERROR! Website Shop (' .. player:getName() .. ') - cannot create container - invalid container ID - CONTAINER ID:' .. containerId)
					return false
				end
				-- Change container UniqueID to object of class Container
				local newContainer = Container(newContainerUID)

				-- Add items to container
				for i = 1, containerItemsInsideCount do
					-- Create new item
					local newItemUID = doCreateItemEx(itemId, itemCount)
					-- Item does not exist, wrong id OR count
					if not newItemUID then
						player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'Website Shop bugged. Contact with administrator! Error is visible in server console.')
						Spdlog.error('ERROR! Website Shop (' .. player:getName() .. ') - cannot create item - invalid item ID OR count - ITEM ID: ' .. itemId .. ', ITEM COUNT: ' .. itemCount)
						return false
					end
					-- Add item to container
					local newItem = Item(newItemUID)
					local addItemToContainerResult = newContainer:addItemEx(newItem)
					-- Report error if it's not possible to add item to container
					if type(addItemToContainerResult) ~= "number" or addItemToContainerResult ~= RETURNVALUE_NOERROR then
						player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'Website Shop bugged. Contact with administrator! Error is visible in server console.')
						Spdlog.error('ERROR! Website Shop (' .. player:getName() .. ') - cannot add item to container - item is not pickable OR variable "RETURNVALUE_NOERROR" is not defined in LUA - ITEM ID: ' .. itemId .. ', ITEM COUNT: ' .. itemCount)
						return false
					end
				end

				-- Cannot open Store Inbox, report problem
				if not playerStoreInbox then
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'Website Shop bugged. Contact with administrator! Error is visible in server console.')
					Spdlog.error('ERROR! Website Shop (' .. player:getName() .. ') - cannot open player "Store Inbox" - it is not supported in your server OR variable "CONST_SLOT_STORE_INBOX" is not defined in LUA')
					return false
				end
				-- Add container with items to Store Inbox
				receivedItemStatus = playerStoreInbox:addItemEx(newContainer)

				if type(receivedItemStatus) == "number" and receivedItemStatus == RETURNVALUE_NOERROR then
					player:getPosition():sendMagicEffect(CONST_ME_GIFT_WRAPS)
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'You received ' .. shopOfferName .. ' from Website Shop. You can find your item in Store Inbox.')
					db.asyncQuery("DELETE FROM `z_ots_comunication` WHERE `id` = " .. transactionId)
					db.asyncQuery("UPDATE `z_shop_history_item` SET `trans_state`= 'realized', `trans_real`=" .. os.time() .. " WHERE `id` = " .. transactionId)
					return true
				else
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'Website Shop bugged. Contact with administrator! Error is visible in server console.')
					Spdlog.error('ERROR! Website Shop (' .. player:getName() .. ') - cannot add container with items to Store Inbox - unknown reason, is it\'s size limited and it is full? - ITEM ID: ' .. itemId .. ', ITEM COUNT: ' .. itemCount .. ', CONTAINER ID:' .. containerId .. ', ITEMS IN CONTAINER COUNT:' .. containerItemsInsideCount)
					return false
				end
			end

			-- Deliver Mount
			if shopOfferType == 'mount' then
				if player:hasMount(itemId) then
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'You already have the ' .. shopOfferName .. '. Your coins were returned.')
					db.asyncQuery("DELETE FROM `z_ots_comunication` WHERE `id` = " .. transactionId)
					db.asyncQuery("UPDATE `accounts` SET `coins` = `coins` + " .. coins .. " WHERE id = " .. player:getAccountId())
				else
					player:getPosition():sendMagicEffect(CONST_ME_GIFT_WRAPS)
					player:addMount(itemId)
					player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'You received ' .. shopOfferName .. ' from Website Shop.')
					db.asyncQuery("DELETE FROM `z_ots_comunication` WHERE `id` = " .. transactionId)
					db.asyncQuery("UPDATE `z_shop_history_item` SET `trans_state`= 'realized', `trans_real`=" .. os.time() .. " WHERE `id` = " .. transactionId)
					return true
				end
			end

			-- Deliver Outfit
			local outfitName = result.getDataString(resultId, "param9")
			if shopOfferType == 'outfit' then
				if outfitName ~= "" and maleOutfits[outfitName] and femaleOutfits[outfitName][1] or maleOutfits[outfitName][1] then
					local addOutfit = getPlayerSex() == 0 and femaleOutfits[outfitName][1] or maleOutfits[outfitName][1]
					if player:hasOutfit(addOutfit, 3) then
						player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'You already have the ' .. shopOfferName .. '. Your coins were returned.')
						db.asyncQuery("DELETE FROM `z_ots_comunication` WHERE `id` = " .. transactionId)
						db.asyncQuery("UPDATE `accounts` SET `coins` = `coins` + " .. coins .. " WHERE id = " .. player:getAccountId())
					else
						player:getPosition():sendMagicEffect(CONST_ME_GIFT_WRAPS)
						player:addOutfitAddon(addOutfit, 3)
						player:sendTextMessage(MESSAGE_EVENT_ADVANCE, 'You received ' .. shopOfferName .. ' from Website Shop.')
						db.asyncQuery("DELETE FROM `z_ots_comunication` WHERE `id` = " .. transactionId)
						db.asyncQuery("UPDATE `z_shop_history_item` SET `trans_state`= 'realized', `trans_real`=" .. os.time() .. " WHERE `id` = " .. transactionId)
						return true
					end
				end
			end
		end
		until not result.next(resultId)
		result.free(resultId)
	end
	return true
end

gesiorShopSystem:interval(30000)
gesiorShopSystem:register()
